# ============================================
# Tokamak Private App Channels Manager
# Docker Compose for Development
# ============================================
#
# Usage:
#   Development:  docker-compose up
#   Production:   docker-compose -f docker-compose.yml -f docker-compose.prod.yml up
#   E2E Tests:    docker-compose -f docker-compose.yml -f docker-compose.test.yml up
#
# Environment variables (create .env file or pass directly):
#   RPC_URL=https://eth-sepolia.g.alchemy.com/v2/YOUR_KEY
#   NEXT_PUBLIC_ALCHEMY_API_KEY=YOUR_KEY
#

version: '3.8'

services:
  # ============================================
  # Main Application (Development)
  # ============================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - RPC_URL=${RPC_URL}
      - NEXT_PUBLIC_ALCHEMY_API_KEY=${NEXT_PUBLIC_ALCHEMY_API_KEY}
      - TOKAMAK_ZK_EVM_ROOT=/app/Tokamak-Zk-EVM
    volumes:
      # Mount source code for hot reloading
      - .:/app
      # Exclude node_modules (use container's)
      - /app/node_modules
      - /app/packages/config/node_modules
      # Persist Tokamak-Zk-EVM build artifacts
      - zkevm-dist:/app/Tokamak-Zk-EVM/dist
      # Persist local data
      - ./data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Tokamak-Zk-EVM Setup Service
  # Runs once to initialize the synthesizer
  # ============================================
  zkevm-setup:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    environment:
      - RPC_URL=${RPC_URL}
      - TOKAMAK_ZK_EVM_ROOT=/app/Tokamak-Zk-EVM
    volumes:
      - ./Tokamak-Zk-EVM:/app/Tokamak-Zk-EVM
      - zkevm-dist:/app/Tokamak-Zk-EVM/dist
    command: >
      bash -c "
        if [ ! -f /app/Tokamak-Zk-EVM/dist/.installed ]; then
          echo 'üîß Setting up Tokamak-Zk-EVM...'
          cd /app/Tokamak-Zk-EVM
          dos2unix tokamak-cli scripts/* 2>/dev/null || true
          chmod +x tokamak-cli scripts/* 2>/dev/null || true
          if [ -n \"$$RPC_URL\" ]; then
            ./tokamak-cli --install \"$$RPC_URL\" --bun && touch dist/.installed
          else
            echo '‚ö†Ô∏è  RPC_URL not set. Skipping tokamak-cli install.'
            echo 'Set RPC_URL in .env and run: docker-compose run zkevm-setup'
          fi
        else
          echo '‚úÖ Tokamak-Zk-EVM already installed'
        fi
      "
    profiles:
      - setup

volumes:
  zkevm-dist:
    name: tokamak-zkevm-dist

networks:
  default:
    name: tokamak-network
