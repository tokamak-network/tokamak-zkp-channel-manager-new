# ============================================
# Tokamak Private App Channels Manager
# Docker Compose Override for E2E Testing
# ============================================
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.test.yml up --abort-on-container-exit
#
# This runs:
#   1. Anvil (Foundry) - Local Ethereum fork
#   2. App in production mode connected to Anvil
#   3. Playwright E2E tests against the app
#

version: '3.8'

services:
  # ============================================
  # Anvil - Local Ethereum Fork
  # ============================================
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: ["anvil"]
    command: >
      --fork-url ${RPC_URL}
      --fork-block-number ${FORK_BLOCK_NUMBER:-7000000}
      --host 0.0.0.0
      --port 8545
      --accounts 10
      --balance 10000
      --chain-id 11155111
    ports:
      - "8545:8545"
    healthcheck:
      test: ["CMD", "curl", "-sf", "-X", "POST", "-H", "Content-Type: application/json", "--data", '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}', "http://localhost:8545"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ============================================
  # Token Setup - Fund test accounts with TON
  # ============================================
  token-setup:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: ["sh", "-c"]
    command: |
      echo "Waiting for Anvil to be ready..."
      sleep 5
      
      # Test accounts (Anvil default)
      LEADER="0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"
      PARTICIPANT="0x70997970C51812dc3A010C7d01b50e0d17dc79C8"
      
      # TON Token address on Sepolia
      TON_ADDRESS="0xa30fe40285B8f5c0457DbC3B7C8A280373c40044"
      
      # Amount to mint (1000 TON = 1000 * 10^18)
      AMOUNT="0x3635c9adc5dea00000"
      
      echo "Setting up test account balances..."
      
      # Use Anvil's setBalance to give ETH
      cast rpc anvil_setBalance $$LEADER 0x21e19e0c9bab2400000 --rpc-url http://anvil:8545 || true
      cast rpc anvil_setBalance $$PARTICIPANT 0x21e19e0c9bab2400000 --rpc-url http://anvil:8545 || true
      
      # Use storage manipulation to set TON balances
      # TON uses slot 0 for balances
      # keccak256(abi.encode(address, 0)) for balance slot
      echo "Setting TON balances..."
      
      # Calculate storage slots (simplified - actual implementation may vary)
      # For testing, we'll use anvil_setStorageAt
      
      echo "Token setup complete!"
    depends_on:
      anvil:
        condition: service_healthy
    profiles:
      - setup

  # ============================================
  # Override app for testing
  # ============================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
    environment:
      - NODE_ENV=production
      # Use Anvil instead of real RPC
      - RPC_URL=http://anvil:8545
      - NEXT_PUBLIC_ALCHEMY_API_KEY=${NEXT_PUBLIC_ALCHEMY_API_KEY}
    depends_on:
      anvil:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  # ============================================
  # E2E Test Runner
  # ============================================
  e2e:
    build:
      context: .
      dockerfile: Dockerfile
      target: e2e-test
    environment:
      - BASE_URL=http://app:3000
      - ANVIL_URL=http://anvil:8545
      - CI=true
    depends_on:
      app:
        condition: service_healthy
    volumes:
      # Output test results
      - ./test-results:/app/test-results
      - ./playwright-report:/app/playwright-report
      - ./channel-test-state.json:/app/channel-test-state.json
    command: npx playwright test --reporter=html

  # ============================================
  # E2E Channel Lifecycle Tests
  # ============================================
  e2e-lifecycle:
    build:
      context: .
      dockerfile: Dockerfile
      target: e2e-test
    environment:
      - BASE_URL=http://app:3000
      - ANVIL_URL=http://anvil:8545
      - CI=true
    depends_on:
      app:
        condition: service_healthy
    volumes:
      - ./test-results:/app/test-results
      - ./playwright-report:/app/playwright-report
      - ./channel-test-state.json:/app/channel-test-state.json
    # Run lifecycle tests in order
    command: >
      sh -c "
        npx playwright test e2e/steps/01-create-channel.spec.ts --reporter=list &&
        npx playwright test e2e/steps/02-deposit.spec.ts --reporter=list &&
        npx playwright test e2e/steps/03-initialize.spec.ts --reporter=list &&
        npx playwright test e2e/steps/04-l2-transaction.spec.ts --reporter=list &&
        npx playwright test e2e/steps/05-submit-proof.spec.ts --reporter=list &&
        npx playwright test e2e/steps/06-close-channel.spec.ts --reporter=list &&
        npx playwright test e2e/steps/07-withdraw.spec.ts --reporter=list
      "
    profiles:
      - lifecycle

  # ============================================
  # Visual regression testing (optional)
  # ============================================
  visual-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: e2e-test
    environment:
      - BASE_URL=http://app:3000
      - ANVIL_URL=http://anvil:8545
      - CI=true
    depends_on:
      app:
        condition: service_healthy
    volumes:
      - ./test-results:/app/test-results
      - ./screenshots:/app/screenshots
    command: npx playwright test --project=visual
    profiles:
      - visual
